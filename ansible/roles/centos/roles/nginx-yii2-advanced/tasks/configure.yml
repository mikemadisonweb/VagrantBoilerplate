---
- name: Copy Nginx main config
  template:
    src:  "nginx.conf.j2"
    dest: "{{ nginx.base_path }}/nginx.conf"
    validate: "nginx -t -c %s"

- name: Create folder conf.d
  file:
    path: "{{ nginx.config_path }}"
    state: directory

- name: Delete default config
  file:
    path: "{{ nginx.config_path }}/default.conf"
    state: absent

- name: Make sites available
  template:
    src: "{{item}}.conf.j2"
    dest: "{{ nginx.config_path }}/{{item}}.conf"
    backup: yes
  with_items: "{{ nginx.sites }}"
  when: nginx.sites is defined
  notify:
      - Enable nginx
      - Restart nginx